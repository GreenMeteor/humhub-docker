name: Update HumHub version

on:
  workflow_run:
    workflows: ["Check for HumHub Updates"]
    types:
      - completed

jobs:
  update-dockerfile:
    name: Update Dockerfile
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.outputs.update_available == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set permissions for version.txt and Dockerfile
        run: |
          chmod 644 ./src/version.txt
          chmod 644 ./src/Dockerfile

      - name: Get latest version from version.txt
        id: get_version
        run: |
          echo "Reading version.txt..."
          latest_version=$(cat ./src/version.txt)
          echo "::set-output name=version::$latest_version"

      - name: Update Dockerfile
        run: |
          current_url=$(grep -oP '(?<=https://download.humhub.com/downloads/install/humhub-)[0-9]+\.[0-9]+\.[0-9]+\.zip' ./src/Dockerfile)
          new_url="https://download.humhub.com/downloads/install/humhub-${{ steps.get_version.outputs.version }}.zip"
          sed -i "s|$current_url|$new_url|" ./src/Dockerfile

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ./src/Dockerfile
          git commit -m "Update HumHub version to ${{ steps.get_version.outputs.version }}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update HumHub version to ${{ steps.get_version.outputs.version }}"
          title: "Update HumHub to version ${{ steps.get_version.outputs.version }}"
          body: "This PR updates the HumHub version in the Dockerfile to ${{ steps.get_version.outputs.version }}."
